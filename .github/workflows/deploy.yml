name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4 # 升级到 v4

    - uses: actions/setup-node@v4 # 升级到 v4
      with:
        node-version: 20 # 建议使用 LTS 版本

    - name: Install Dependencies
      run: yarn install

    - name: Build
      run: yarn build
      env:
        NODE_ENV: production

    - name: Publish to Cloudflare
      uses: cloudflare/wrangler-action@v3 # 核心升级：从 v1 升级到 v3
      with:
        apiToken: ${{ secrets.CF_API_TOKEN }}
        accountId: ${{ secrets.CF_ACCOUNT_ID }}
        # 将动态创建 KV 的逻辑放入 preCommands
        preCommands: |
          # 1. 尝试创建 KV（如果已存在会报错但被 || true 忽略）zhouzm
          npx wrangler kv:namespace create KV_STATUS_PAGE || true
          
          # 2. 现代化的方式获取 ID 并写入配置
          # 使用 --json 参数更稳定，不再需要依赖 v1 的 npx 
          KV_JSON=$(npx wrangler kv:namespace list --json)
          KV_ID=$(echo $KV_JSON | node -e "const kvs = JSON.parse(fs.readFileSync(0)); const target = kvs.find(kv => kv.title.includes('KV_STATUS_PAGE')); console.log(target ? target.id : '')")
          
          if [ -z "$KV_ID" ]; then echo "Failed to find KV_ID"; exit 1; fi
          
          # 3. 写入 wrangler.toml (注意: v3 推荐直接写在顶层或具体环境里)
          echo -e "\n[[kv_namespaces]]\nbinding = \"KV_STATUS_PAGE\"\nid = \"$KV_ID\"" >> wrangler.toml
          
          # 4. 检查 Secrets (保持你的原有逻辑)
          [ -z "$SECRET_SLACK_WEBHOOK_URL" ] && SECRET_SLACK_WEBHOOK_URL="dummy" || true
          [ -z "$SECRET_TELEGRAM_API_TOKEN" ] && SECRET_TELEGRAM_API_TOKEN="dummy" || true
          [ -z "$SECRET_TELEGRAM_CHAT_ID" ] && SECRET_TELEGRAM_CHAT_ID="dummy" || true
          [ -z "$SECRET_DISCORD_WEBHOOK_URL" ] && SECRET_DISCORD_WEBHOOK_URL="dummy" || true

        postCommands: |
          yarn kv-gc
        
        # Wrangler v3 自动处理环境变量同步，无需专门的 secrets 配置项
        # 直接通过 env 传入即可
      env:
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        SECRET_SLACK_WEBHOOK_URL: ${{ secrets.SECRET_SLACK_WEBHOOK_URL }}
        SECRET_TELEGRAM_API_TOKEN: ${{ secrets.SECRET_TELEGRAM_API_TOKEN }}
        SECRET_TELEGRAM_CHAT_ID: ${{ secrets.SECRET_TELEGRAM_CHAT_ID }}
        SECRET_DISCORD_WEBHOOK_URL: ${{ secrets.SECRET_DISCORD_WEBHOOK_URL }}
